<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chat Widget - Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .demo-container {
        max-width: 1200px;
        width: 100%;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .info-panel {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        flex: 1;
        min-width: 300px;
      }

      .info-panel h1 {
        font-size: 28px;
        color: #2d3748;
        margin-bottom: 10px;
      }

      .info-panel p {
        color: #718096;
        line-height: 1.6;
        margin-bottom: 20px;
      }

      .features {
        list-style: none;
        margin: 20px 0;
      }

      .features li {
        padding: 10px 0;
        color: #4a5568;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .features li:before {
        content: "‚úì";
        color: #48bb78;
        font-weight: bold;
        font-size: 18px;
      }

      .badge {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 10px;
      }

      /* Chat Widget Styles */
      #chat-widget {
        position: relative;
        width: 400px;
        height: 600px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .chat-header-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .bot-avatar {
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .chat-header h3 {
        font-size: 18px;
        font-weight: 600;
      }

      .chat-status {
        font-size: 12px;
        opacity: 0.9;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f7fafc;
      }

      .message {
        margin-bottom: 16px;
        display: flex;
        gap: 10px;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
      }

      .message.user .message-avatar {
        background: #48bb78;
      }

      .message-content {
        max-width: 70%;
        background: white;
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        word-wrap: break-word;
      }

      .message.user .message-content {
        background: #667eea;
        color: white;
      }

      .message-text {
        font-size: 14px;
        line-height: 1.5;
      }

      .message-meta {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 8px;
        font-size: 11px;
        color: #a0aec0;
      }

      .sentiment-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .sentiment-low {
        background: #c6f6d5;
        color: #22543d;
      }

      .sentiment-medium {
        background: #feebc8;
        color: #7c2d12;
      }

      .sentiment-high {
        background: #fed7d7;
        color: #742a2a;
      }

      .message-sources {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #e2e8f0;
      }

      .source-item {
        font-size: 11px;
        color: #4a5568;
        padding: 4px 0;
      }

      .source-item:before {
        content: "üìÑ";
        margin-right: 4px;
      }

      .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: #cbd5e0;
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-10px);
        }
      }

      .chat-input-container {
        padding: 16px;
        background: white;
        border-top: 1px solid #e2e8f0;
      }

      .chat-input-wrapper {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 24px;
        font-size: 14px;
        outline: none;
        transition: all 0.2s;
        resize: none;
        max-height: 120px;
        font-family: inherit;
      }

      .chat-input:focus {
        border-color: #667eea;
      }

      .send-button {
        background: #667eea;
        color: white;
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .send-button:hover {
        background: #5568d3;
        transform: scale(1.05);
      }

      .send-button:active {
        transform: scale(0.95);
      }

      .send-button:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
        transform: none;
      }

      /* Quick Actions */
      .quick-actions {
        display: flex;
        gap: 8px;
        padding: 0 16px 16px;
        flex-wrap: wrap;
      }

      .quick-action {
        padding: 8px 16px;
        background: #edf2f7;
        border: 1px solid #e2e8f0;
        border-radius: 20px;
        font-size: 12px;
        color: #4a5568;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quick-action:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      /* Scrollbar */
      .chat-messages::-webkit-scrollbar {
        width: 6px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 3px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
      }

      /* Error message */
      .error-message {
        background: #fed7d7;
        color: #742a2a;
        padding: 12px 16px;
        border-radius: 8px;
        margin: 16px;
        font-size: 14px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .demo-container {
          flex-direction: column;
        }

        #chat-widget {
          width: 100%;
          max-width: 400px;
          height: 500px;
        }

        .info-panel {
          max-width: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="demo-container">
      <!-- Info Panel -->
      <div class="info-panel">
        <h1>ü§ñ AI Support Chat</h1>
        <p>
          Experience intelligent customer support powered by AI and RAG
          technology.
        </p>

        <ul class="features">
          <li>Instant AI-powered responses</li>
          <li>Context-aware conversations</li>
          <li>Sentiment analysis</li>
          <li>Source citations</li>
          <li>24/7 availability</li>
        </ul>

        <div>
          <span class="badge">OpenAI GPT-4</span>
          <span class="badge">RAG Enabled</span>
          <span class="badge">Real-time</span>
        </div>

        <div
          style="
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
          "
        >
          <p style="font-size: 12px; color: #a0aec0">
            Try asking:<br />
            ‚Ä¢ "How do I reset my password?"<br />
            ‚Ä¢ "What's your refund policy?"<br />
            ‚Ä¢ "Tell me about your services"
          </p>
        </div>
      </div>

      <!-- Chat Widget -->
      <div id="chat-widget">
        <div class="chat-header">
          <div class="chat-header-info">
            <div class="bot-avatar">ü§ñ</div>
            <div>
              <h3>AI Support</h3>
              <div class="chat-status">‚óè Online</div>
            </div>
          </div>
        </div>

        <div class="quick-actions">
          <button class="quick-action" onclick="sendQuickMessage('Hello!')">
            üëã Say Hello
          </button>
          <button
            class="quick-action"
            onclick="sendQuickMessage('How do I reset my password?')"
          >
            üîê Reset Password
          </button>
          <button
            class="quick-action"
            onclick="sendQuickMessage('I need help')"
          >
            ‚ùì Get Help
          </button>
        </div>

        <div class="chat-messages" id="chatMessages">
          <!-- Welcome message -->
          <div class="message bot">
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
              <div class="message-text">
                Hi! I'm your AI assistant. How can I help you today?
              </div>
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea
              class="chat-input"
              id="chatInput"
              placeholder="Type your message..."
              rows="1"
              onkeypress="handleKeyPress(event)"
            ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      // const API_BASE_URL = "https://melodious-connection-production.up.railway.app";
      const API_BASE_URL =
        "https://melodious-connection-production.up.railway.app";
      const ORGANIZATION_ID = "demo_org";
      let conversationId = null;

      // Auto-resize textarea
      const chatInput = document.getElementById("chatInput");
      chatInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      // Handle Enter key
      function handleKeyPress(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }

      // Quick message
      function sendQuickMessage(message) {
        chatInput.value = message;
        sendMessage();
      }

      // Send message
      async function sendMessage() {
        console.log("sendMessage called");

        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        console.log("Message:", message);

        if (!message) return;

        // Clear input
        input.value = "";
        input.style.height = "auto";

        // Disable send button
        const sendButton = document.getElementById("sendButton");
        sendButton.disabled = true;

        // Add user message to chat
        addMessage("user", message);

        // Show typing indicator
        showTypingIndicator();

        try {
          console.log("About to fetch...");
          console.log("URL:", `${API_BASE_URL}/api/chat/message`);

          // Call API
          const response = await fetch(`${API_BASE_URL}/api/chat/message`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              organization_id: ORGANIZATION_ID,
              conversation_id: conversationId,
            }),
          });

          console.log("Response received:", response); // ADD THIS

          // ... rest of the function

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Hide typing indicator
          hideTypingIndicator();

          // Save conversation ID
          if (data.conversation_id) {
            conversationId = data.conversation_id;
          }

          // Add bot response
          addMessage("bot", data.response, {
            sentiment: data.sentiment,
            sources: data.sources,
          });
        } catch (error) {
          console.error("Error:", error);
          hideTypingIndicator();
          addErrorMessage("Sorry, something went wrong. Please try again.");
        } finally {
          sendButton.disabled = false;
          input.focus();
        }
      }

      // Add message to chat
      function addMessage(role, text, metadata = {}) {
        const messagesContainer = document.getElementById("chatMessages");

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role}`;

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = role === "user" ? "üë§" : "ü§ñ";

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        const textDiv = document.createElement("div");
        textDiv.className = "message-text";
        textDiv.textContent = text;

        contentDiv.appendChild(textDiv);

        // Add metadata for bot messages
        if (role === "bot" && metadata.sentiment) {
          const metaDiv = document.createElement("div");
          metaDiv.className = "message-meta";

          const sentimentBadge = document.createElement("span");
          sentimentBadge.className = `sentiment-badge sentiment-${metadata.sentiment.priority.toLowerCase()}`;
          sentimentBadge.textContent = metadata.sentiment.priority;

          metaDiv.appendChild(sentimentBadge);
          metaDiv.appendChild(
            document.createTextNode(` ‚Ä¢ ${new Date().toLocaleTimeString()}`)
          );

          contentDiv.appendChild(metaDiv);
        }

        // Add sources
        if (role === "bot" && metadata.sources && metadata.sources.length > 0) {
          const sourcesDiv = document.createElement("div");
          sourcesDiv.className = "message-sources";

          metadata.sources.forEach((source) => {
            const sourceItem = document.createElement("div");
            sourceItem.className = "source-item";
            sourceItem.textContent = `${
              source.metadata?.title || "Document"
            } (${Math.round(source.score * 100)}%)`;
            sourcesDiv.appendChild(sourceItem);
          });

          contentDiv.appendChild(sourcesDiv);
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Show typing indicator
      function showTypingIndicator() {
        const messagesContainer = document.getElementById("chatMessages");

        const typingDiv = document.createElement("div");
        typingDiv.className = "message bot";
        typingDiv.id = "typingIndicator";

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = "ü§ñ";

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        const typingIndicator = document.createElement("div");
        typingIndicator.className = "typing-indicator";
        typingIndicator.innerHTML =
          '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

        contentDiv.appendChild(typingIndicator);
        typingDiv.appendChild(avatar);
        typingDiv.appendChild(contentDiv);

        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Hide typing indicator
      function hideTypingIndicator() {
        const indicator = document.getElementById("typingIndicator");
        if (indicator) {
          indicator.remove();
        }
      }

      // Add error message
      function addErrorMessage(message) {
        const messagesContainer = document.getElementById("chatMessages");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.textContent = message;
        messagesContainer.appendChild(errorDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Focus input on load
      window.addEventListener("load", () => {
        document.getElementById("chatInput").focus();
      });
    </script>
  </body>
</html>
